name: deploy

on:
  workflow_call:
    inputs:
      service:
        description: "Service name"
        required: true
        type: string
      container:
        description: "Container name"
        required: true
        type: string
      image:
        description: "Image to deploy"
        required: true
        type: string
    secrets:
      DOCKER_REGISTRY:
        required: true
      KUBE_URL:
        required: true
      KUBE_CONFIG:
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: azure/setup-kubectl@v2.0

      - uses: Azure/k8s-set-context@v2
        with:
          method: service-account
          k8s-url: ${{ secrets.KUBE_URL }}
          k8s-secret: ${{ secrets.KUBE_CONFIG }}

      -
        name: Set image
        run: |
          DEPLOYMENT=`kubectl get deployments -l service=${{ inputs.service }} --output 'jsonpath={.items[0].metadata.name}'`
          kubectl set image --record deployment/$DEPLOYMENT ${{ inputs.container }}=${{ secrets.DOCKER_REGISTRY }}/${{ inputs.image }}
          kubectl rollout status deployment/$DEPLOYMENT
